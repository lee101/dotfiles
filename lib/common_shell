#!/bin/sh
# common_shell - Shared configuration for bash and zsh
# Source this from both ~/.bashrc and ~/.zshrc
# Keep shell-specific features in their respective files

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# ============================================================
# Environment variables
# ============================================================
export DOCKER_BUILDKIT=1
export NODE_OPTIONS="--max-old-space-size=8192"
export GO111MODULE=on
export GOPROXY=https://proxy.golang.org,direct
export GOSUMDB=sum.golang.org
export GIT_EDITOR=nvim
export EDITOR="nvim"
export VISUAL="nvim"
export LESS="-eirMX"
export AWS_REGION=us-east-1
export RAILS_ENV=development

# History settings
export HISTFILESIZE=9999999
export HISTSIZE=9999999
export HISTTIMEFORMAT="[%F %T] "

# Chrome profile
export CHROME_PROFILE_PATH="$HOME/code/dotfiles/tools/chrome_profiles_export"

# Claude timeout configurations
export BASH_DEFAULT_TIMEOUT_MS=1800000
export BASH_MAX_TIMEOUT_MS=1800000
export MCP_TIMEOUT=1800000
export MCP_TOOL_TIMEOUT=1800000
export MAX_MCP_OUTPUT_TOKENS=100000
export DISABLE_COST_WARNINGS=1
export CLAUDE_CODE_DISABLE_TERMINAL_TITLE=0

# ============================================================
# PATH setup
# ============================================================
# Go
export GOPATH=$HOME/go
[ -d "/usr/local/go/bin" ] && export GOROOT=/usr/local/go
[ -n "$GOROOT" ] && [[ ":$PATH:" != *":$GOROOT/bin:"* ]] && export PATH="$GOROOT/bin:$PATH"
[[ ":$PATH:" != *":$GOPATH/bin:"* ]] && export PATH="$PATH:$GOPATH/bin"

# CUDA
[ -d "/usr/local/cuda-12.0/bin" ] && export PATH="/usr/local/cuda-12.0/bin:$PATH"
[ -d "/usr/local/cuda-12/bin" ] && export PATH="/usr/local/cuda-12/bin:$PATH"
export CUDA_HOME='/usr/local/cuda-12.0'

# Various tools
[ -d "$HOME/.local/bin" ] && [[ ":$PATH:" != *":$HOME/.local/bin:"* ]] && export PATH="$HOME/.local/bin:$PATH"
[ -d "$HOME/programs" ] && [[ ":$PATH:" != *":$HOME/programs:"* ]] && export PATH="$PATH:$HOME/programs"
[ -d "$HOME/.rvm/bin" ] && export PATH="$PATH:$HOME/.rvm/bin"
[ -d "/opt/nvim-linux64/bin" ] && export PATH="$PATH:/opt/nvim-linux64/bin"
[ -d "$HOME/.pixi/bin" ] && export PATH="$HOME/.pixi/bin:$PATH"
[ -d "$HOME/code/dotfiles/tools" ] && [[ ":$PATH:" != *":$HOME/code/dotfiles/tools:"* ]] && export PATH="$PATH:$HOME/code/dotfiles/tools"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
[[ ":$PATH:" != *":$PNPM_HOME:"* ]] && export PATH="$PNPM_HOME:$PATH"

# bun
export BUN_INSTALL="$HOME/.bun"
[[ ":$PATH:" != *":$BUN_INSTALL/bin:"* ]] && export PATH="$BUN_INSTALL/bin:$PATH"

# ZVM
[ -d "$HOME/.zvm" ] && {
    export ZVM_INSTALL="$HOME/.zvm/self"
    export PATH="$PATH:$HOME/.zvm/bin:$ZVM_INSTALL/"
}

# Java
if [ -d "$HOME/.jdks/openjdk-23.0.2" ]; then
    export JAVA_HOME=$HOME/.jdks/openjdk-23.0.2
    export PATH="$PATH:$JAVA_HOME/bin"
fi

# Scala/Maven
[ -d "$HOME/programs/scala-2.11.2" ] && {
    export SCALA_HOME="$HOME/programs/scala-2.11.2"
    export PATH="$PATH:$SCALA_HOME/bin"
}
[ -d "$HOME/programs/apache-maven-3.2.3" ] && {
    export M2_HOME="$HOME/programs/apache-maven-3.2.3"
    export M2="$M2_HOME/bin"
    export PATH="$M2:$PATH"
}

# Heroku
[ -d "/usr/local/heroku/bin" ] && export PATH="/usr/local/heroku/bin:$PATH"

# Modular/Mojo
[ -d "$HOME/.modular" ] && {
    export MODULAR_HOME="$HOME/.modular"
    export PATH="$MODULAR_HOME/pkg/packages.modular.com_mojo/bin:$PATH"
    export PATH="$PATH:$HOME/.modular/bin"
}

# opencode
[ -d "$HOME/.opencode/bin" ] && export PATH="$HOME/.opencode/bin:$PATH"

# ============================================================
# Color support
# ============================================================
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
fi
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# ============================================================
# Directory listing (eza or fallback to ls)
# ============================================================
if command -v eza >/dev/null 2>&1; then
    alias ls='eza --group-directories-first --color=auto'
    alias ll='eza -al --group-directories-first --classify --git'
    alias la='eza -a --group-directories-first --classify'
    alias l='eza --classify --group-directories-first'
    alias lt='eza --long --all --sort=modified --reverse --group-directories-first'
    alias ltree='eza --tree --level=2 --group-directories-first --classify'
    alias lsize='eza -al --sort=size --reverse --group-directories-first'
    alias lrecent='eza -al --sort=modified --reverse --group-directories-first'
    alias tree='eza --tree'
else
    alias ls='ls --color=auto'
    alias ll='ls -alF'
    alias la='ls -A'
    alias l='ls -CF'
    alias lt='ls -lttra'
    alias ltree='tree -L 2'
    alias lsize='ls -lSh'
    alias lrecent='ls -ltr'
fi

# ============================================================
# Navigation aliases
# ============================================================
alias d='cd'
alias c='cd ~/code'
alias u='cd ..'

# ============================================================
# General aliases
# ============================================================
alias r='rm -rf'
alias rr='trash-put'
alias tli='terraform console'
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'
alias v=nvim
alias vi=nvim
alias vim=nvim
alias n=nvim
alias ni=nvim
alias k='kubectl'
alias y="yarn"
alias yi="yarn install"
alias pn=pnpm
alias br='bun run'
alias pip='uv pip'
# 'o' and 'oo' aliases set in cross_platform_utils or shell-specific config

# ============================================================
# Python / uv aliases
# ============================================================
alias uva='source .venv/bin/activate'
alias sve='source .venv/bin/activate'
alias sni='sudo snap install --classic'
alias bi='bun install'
alias ba='bun add'
alias pfr='pip freeze'
alias ipy='ipython'
alias pfrr='pip freeze > requirements.txt'
alias pin='uv pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org --trusted-host download.pytorch.org'
alias pinu='uv pip install -U --trusted-host pypi.org --trusted-host files.pythonhosted.org --trusted-host download.pytorch.org'
alias pc='uv pip compile requirements.in -o requirements.txt && uv pip install -r requirements.txt --python .venv/bin/python'

pins() {
    local package_name=$1
    local requirements_file=${2:-./requirements.txt}
    uv pip install "$package_name" --trusted-host pypi.org --trusted-host files.pythonhosted.org --trusted-host download.pytorch.org && pip freeze | grep -i "$package_name" >> "$requirements_file"
}

# ============================================================
# Bun aliases
# ============================================================
alias brb='bun run build'
alias brl='bun run lint'
alias brf='bun run format'
alias brt='bun run test'

# ============================================================
# Docker aliases
# ============================================================
alias dps='docker ps'
alias dim='docker images'
alias dlg='docker logs'
alias drm='docker rm'
alias drmi='docker rmi'
alias dkl='docker kill'
alias dstt='docker start'
alias dstp='docker stop'
alias sdtpa='docker stop $(docker ps -q)'
alias dklall='docker stop $(docker ps -a -q); docker rm $(docker ps --no-trunc -a -q)'
alias dkillall='docker stop $(docker ps -a -q); docker rm $(docker ps --no-trunc -a -q)'
alias dkillunused='docker rm $(docker ps --no-trunc -a -q); docker rmi $(docker images -a -q)'
alias dprna='docker system prune -a --volumes'
alias dprn='docker system prune'
alias ddf='docker system df'

dbash()  { docker run -i -t -u root --entrypoint=/bin/bash "$@" -c /bin/bash; }
dbashg() { docker run -i -t --entrypoint=/bin/bash --gpus all "$@" -c /bin/bash; }
dbashu() { docker run -i -t --entrypoint=/bin/bash "$@" -c /bin/bash; }
dbashe() { docker exec -it "$@" /bin/bash; }

# ============================================================
# Kubernetes aliases
# ============================================================
alias klg='k logs -n'
alias kdlp='k delete pod -n'
alias kdsp='k describe pod -n'
alias kdsn='k describe node'
alias kdlpn='k delete pod --all -n'
alias kdlap='kdlpn'
kbash() { k exec -it -n "$@" -- /bin/bash; }
ksh()   { k exec -it -n "$@" -- /bin/sh; }

# ============================================================
# Git aliases
# ============================================================
alias gst='git status'
alias gstt='git status -uno'
alias gco='git checkout'
alias gcob='git checkout -b'
alias gcom='git checkout master'
alias gcl='git clone --recurse-submodules'
alias gclo='git clone'
alias gcm='git commit -m'
alias gcmn='git commit --no-verify -m'
alias gcmt='git commit'
alias gcmtn='git commit --no-verify'
alias gcmts='git commit --no-edit'
alias gcmtm='git commit --no-edit'
alias gcmtmp='git commit --no-edit && git push'
alias gcma='git commit -a -m'
alias gcman='git commit -a --no-verify -m'
alias gcms='git commit -n -m'
alias gcmamd='git commit --amend -C HEAD'
alias gbr='git branch'
alias gdf='git diff'
alias gd='git diff'
alias gdfc='git diff --cached'
alias gdfx='git diff --cached'
alias gdfm='git diff --diff-filter=M --ignore-space-change'
alias gdfa='git --no-pager diff -p'
alias gdfac='git --no-pager diff -p --cached'
alias gdfb='git diff master...'
alias gdfbm='git diff main...'
alias gdfbd='git diff develop...'
alias gdfs='git diff --ext-diff'
alias glg='git log'
alias glglee='git log --author=lee'
alias glgme='git log --author=lee'
alias gmg='git merge'
alias gmga='git merge --abort'
alias gmgm='git merge master'
alias gmm='git merge master'
alias gmgmn='git merge main'
alias grb='git rebase'
alias grbi='git rebase -i'
alias grbim='git rebase -i master'
alias grbm='git rebase master'
alias grbc='git rebase --continue'
alias grba='git rebase --abort'
alias grl='git reflog'
alias gad='git add'
alias gadu='git add -u'
alias gadi='git add -i'
alias gada='git add -A'
alias gaa='git add -A'
alias gph='git push; git push --tags'
alias gphf='git push -f; git push -f --tags'
alias gpshf='git push -f; git push -f --tags'
alias gpl='git pull'
alias gplrb='git pull --rebase'
alias gpm='git checkout master;git pull;git checkout -;'
alias gplm='git checkout master;git pull;git checkout -;'
alias gpf='git push -f'
alias gsw='git show'
alias grs='git reset'
alias grsm='git reset master'
alias grsh='git reset --hard'
alias grshh='git reset --hard HEAD'
alias grshm='git reset --hard master'
alias grss='git reset --soft'
alias grssm='git reset --soft master'
alias gcp='git cherry-pick'
alias gcpc='git cherry-pick --continue'
alias gcpa='git cherry-pick --abort'
alias gus='git reset HEAD'
alias gsm='git submodule'
alias gsmu='git submodule update --init'
alias grpo='git remote prune origin'
alias grmt='git remote -v'
alias grmte='git remote -v'
alias grmta='git remote add'
alias grmtau='git remote add upstream'
alias grmtao='git remote add origin'
alias grmts='git remote set-url'
alias grmtsu='git remote set-url upstream'
alias grmtso='git remote set-url origin'
alias grmtr='git remote remove'
alias gclf='git clean -f'
alias grv='git revert'
alias gds='git describe'
alias gw='git whatchanged'
alias gpr='hub pull-request'
alias gprs='hub pr show'
alias gll='git log --graph --pretty=oneline --abbrev-commit'
alias gg="git log --graph --pretty=format:'%C(bold)%h%Creset%C(yellow)%d%Creset %s %C(yellow)%an %C(cyan)%cr%Creset' --abbrev-commit --date=relative"
alias ggs="gg --stat"

# Quick git status variations
alias gsu='git status -uno'
alias gss='git status -s'
alias gstas='git stash save'
alias gsl='git status --long'
alias gdfn='gun'
alias gdfu='git ls-files --others --exclude-standard'

# Modern Git tools
alias lg='lazygit'
alias gti='tig status'
alias tgi='tig status'
alias tg='tig'
alias gdiff='git difftool --no-symlinks --dir-diff'
alias gmerge='git mergetool'

# Difftastic
alias gdft='difft'
alias gdfts='difft --display side-by-side'

# Git push workflows
alias gpsh='SKIP_TESTS=1 git push --no-verify'
alias gpsho='SKIP_TESTS=1 git push --no-verify origin'
alias gpshom='SKIP_TESTS=1 git push --no-verify origin main'
alias gpp='git pull --rebase=false && git push'
alias gpps='git pull --rebase=false && SKIP_TESTS=1 git push --no-verify'
alias gityolo='git add -A && git commit -m "sync" --no-verify && git pull --rebase=false --strategy=ours --no-edit && SKIP_TESTS=1 git push --no-verify'
alias gitsync='git stash && git pull --rebase=false && git stash pop && SKIP_TESTS=1 git push --no-verify'

alias gpu='gsp'
alias gpuf='SKIP_TESTS=1 git push -u origin $(git branch --show-current) --no-verify --force-with-lease'
alias gsu_branch='git push -u origin $(git branch --show-current)'
alias gsuf='SKIP_TESTS=1 git push -u origin $(git branch --show-current) --no-verify'

# ============================================================
# Git functions
# ============================================================
findn() { find . -name "$@"; }

gi() {
    [ "$#" -eq 0 ] && return 0
    for arg in "$@"; do echo "$arg" >> .gitignore; done
    git reset HEAD -- "$@" 2>/dev/null || true
}

gbsu() {
    local current_branch=$(git rev-parse --abbrev-ref HEAD)
    git branch --set-upstream-to=origin/$current_branch $current_branch
}

gcof() {
    local branch_name=$(git branch | fzf)
    git checkout $branch_name
}

gusco() { git reset HEAD "$@"; git checkout -- "$@"; }

gssw() { git stash show "$@"; }
gssw1() { git stash show -p stash@{0}; }
gssw2() { git stash show -p stash@{1}; }
gsp1() { git stash pop -p stash@{0}; }
gsp2() { git stash pop -p stash@{1}; }

gcmp()    { git commit -m "$@"; gpsh_fn; }
gcmpn()   { git commit --no-verify -m "$@"; gpsh_fn; }
gcmpf()   { git commit -m "$@"; git push -f; }
gcmap()   { git commit -a -m "$@"; git push; }
gcmapn()  { git commit -a --no-verify -m "$@"; git push; }
gcmapf()  { git commit -a -m "$@"; git push -f; }
gcme()    { git add -A; git commit -a -m "$@"; }
gcmen()   { git add -A; git commit -a --no-verify -m "$@"; }
gcmep()   { git add -A; git commit -a -m "$@"; gpsh_fn; }
gcmepn()  { git add -A; git commit -a --no-verify -m "$@"; gpsh_fn; }
gcmepf()  { git add -A; git commit -a -m "$@"; git push -f; }

# Helper: push with auto upstream
gpsh_fn() {
    local current_branch=$(git rev-parse --abbrev-ref HEAD)
    git push --set-upstream origin $current_branch
}

gswf() { gsw "$@" | grep '\-\-\- a/' | cut -b 6-; }

gsp() {
    local branch=$(git branch --show-current)
    if git rev-parse --abbrev-ref "$branch@{upstream}" >/dev/null 2>&1; then
        SKIP_TESTS=1 git push --no-verify "$@"
    else
        echo "Setting upstream to origin/$branch and pushing..."
        SKIP_TESTS=1 git push -u origin "$branch" --no-verify "$@"
    fi
}

gsync() {
    local branch=$(git branch --show-current)
    local stashed=0
    echo "Syncing $branch..."
    if ! git diff-index --quiet HEAD --; then
        echo "Stashing changes..."
        git stash
        stashed=1
    fi
    if git rev-parse --abbrev-ref "$branch@{upstream}" >/dev/null 2>&1; then
        git pull --rebase=false
    else
        echo "No upstream set, will create on push"
    fi
    [ "$stashed" = "1" ] && { echo "Restoring changes..."; git stash pop; }
    gsp
}

gcheck() {
    echo "=== Branch Info ==="
    git branch -vv | grep "^*"
    echo ""
    echo "=== Unpushed Commits ==="
    git log @{u}.. --oneline 2>/dev/null || git log origin/main..HEAD --oneline 2>/dev/null || echo "No unpushed commits (or no upstream)"
    echo ""
    echo "=== Status ==="
    git status -sb
}

gstm() {
    local branch=$(git branch --show-current 2>/dev/null)
    if [ -n "$branch" ]; then
        local upstream=$(git rev-parse --abbrev-ref "$branch@{upstream}" 2>/dev/null)
        if [ -n "$upstream" ]; then
            local ahead=$(git rev-list --count @{u}.. 2>/dev/null || echo 0)
            local behind=$(git rev-list --count ..@{u} 2>/dev/null || echo 0)
            echo -e "Branch: \033[1;32m$branch\033[0m → $upstream"
            [ "$ahead" -gt 0 ] && echo -e "  \033[1;33m↑ $ahead commit(s) to push\033[0m"
            [ "$behind" -gt 0 ] && echo -e "  \033[1;36m↓ $behind commit(s) to pull\033[0m"
        else
            echo -e "Branch: \033[1;32m$branch\033[0m \033[1;31m(no upstream!)\033[0m"
        fi
    fi
    git status -sb
}

# Git untracked/new files
gun() {
    local path="${1:-.}"
    git ls-files --others --exclude-standard "$path" 2>/dev/null | while IFS= read -r file; do
        [ -f "$file" ] && { echo -e "\033[1;32m+++ $file\033[0m"; cat "$file" | head -100; echo; }
    done
}

gunl() {
    local path="${1:-.}"
    git ls-files --others --exclude-standard "$path" 2>/dev/null
}

gunaa() {
    echo "=== TRACKED FILE CHANGES ==="
    git --no-pager diff -p
    echo ""
    echo "=== STAGED FILE CHANGES ==="
    git --no-pager diff -p --cached
    echo ""
    echo "=== UNTRACKED FILES ==="
    git ls-files --others --exclude-standard | while IFS= read -r file; do
        echo "=== New file: $file ==="
        git diff --no-index /dev/null "$file" 2>/dev/null || true
        echo
    done
}

# Git diff all (tracked + untracked)
gdfa_all() {
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Not a git repository" >&2; return 1
    fi
    git --no-pager diff --color=always -p HEAD --
    local cnt=0
    while IFS= read -r -d '' f; do
        [ $cnt -eq 0 ] && printf "\n# Untracked files\n"
        cnt=$((cnt + 1))
        git --no-pager diff --color=always --no-index -- /dev/null "$f"
    done < <(git ls-files --others --exclude-standard -z)
    [ -z "$(git status --porcelain)" ] && echo "(no changes)"
}

# Git tools debug
git-tools-debug() {
    echo "=== Git Tools Debug ==="
    echo "Shell: $SHELL"
    for tool in git lazygit tig delta difft gh; do
        if command -v "$tool" >/dev/null 2>&1; then
            echo "✓ $tool: $(command -v "$tool")"
        else
            echo "✗ $tool: not found"
        fi
    done
    echo "Delta pager: $(git config --get core.pager 2>/dev/null || echo 'none')"
}

# ============================================================
# NVIDIA/GPU aliases
# ============================================================
alias smi='nvidia-smi'
alias wsmi='watch -n 1 nvidia-smi'
alias smidmon='nvidia-smi dmon -s um -d 1'
alias smiq='nvidia-smi -q'
alias smil='nvidia-smi -L'
alias smit='nvidia-smi -q -d TEMPERATURE'
alias smic='nvidia-smi -q -d CLOCK'
alias smim='nvidia-smi -q -d MEMORY'
alias nt='nvtop'
alias ntop='nvtop'

# ============================================================
# Claude / Codex / AI tool aliases
# ============================================================
alias cla='ANTHROPIC_API_KEY="" claude'
alias cldc='cld --continue'
alias cldf='cld --continue --fork-session'
alias cldr='cld --resume'
alias cldp='cld --print'
alias cldd='claude --dangerously-skip-permissions'

alias cr='claude-review'
alias creview='claude-review'
alias crc='claude-review --staged'
alias crw='claude-review'

alias ca='cursor-agent-bun -f'
alias cap='cursor-agent-bun -f -p'

# Claude Git workflow
alias ccmt='cldcmt'
alias cgcmep='cldgcmep'
alias cfix='cldfix'
alias cpr='cldpr'

# Codex aliases
alias cdx='codex'
alias cdxd='codex --dangerously-bypass-approvals-and-sandbox'
alias cdxf='codex --full-auto'
alias cdxr='codex --sandbox read-only'
alias cdxw='codex --sandbox workspace-write'
alias cdxa='codex apply'
alias cdxe='codex exec'
alias cdxs='codex --search'
alias cdxo='codex --oss'
alias cdxed='codex exec --dangerously-bypass-approvals-and-sandbox'

alias ccx='codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=xhigh'
alias ccxl='codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=low'
alias ccxm='codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=medium'
alias ccxh='codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=high'
alias cxf='codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=high --full-auto'

cx() {
    local custom_codex="$HOME/code/codex/codex-rs/target/release/codex"
    if [ -x "$custom_codex" ]; then
        "$custom_codex" --yolo3 --dangerously-bypass-approvals-and-sandbox "$@"
    else
        codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=xhigh "$@"
    fi
}

cxi() {
    local custom_codex="$HOME/code/codex/codex-rs/target/release/codex"
    if [ -x "$custom_codex" ]; then
        "$custom_codex" --yolo3 --dangerously-bypass-approvals-and-sandbox --auto-next-idea "$@"
    else
        codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=xhigh --auto-next-idea "$@"
    fi
}

cxn() {
    local custom_codex="$HOME/code/codex/codex-rs/target/release/codex"
    if [ -x "$custom_codex" ]; then
        "$custom_codex" --yolo3 --dangerously-bypass-approvals-and-sandbox --auto-next-steps "$@"
    else
        codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=xhigh --auto-next-steps "$@"
    fi
}

cxm() {
    local custom_codex="$HOME/code/codex/codex-rs/target/release/codex"
    if [ -x "$custom_codex" ]; then
        "$custom_codex" --yolo3 --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=medium "$@"
    else
        codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=medium "$@"
    fi
}

cxl() {
    local custom_codex="$HOME/code/codex/codex-rs/target/release/codex"
    if [ -x "$custom_codex" ]; then
        "$custom_codex" --yolo3 --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=low "$@"
    else
        codex --dangerously-bypass-approvals-and-sandbox --config model_reasoning_effort=low "$@"
    fi
}

cld() {
    ANTHROPIC_API_KEY=""
    bun run "$(which claude)" --dangerously-skip-permissions "$@"
}

codex_wrapper() { command codex "$@"; }
alias codex='codex_wrapper'

cldgdfaa() {
    [ -z "$1" ] && { echo "Usage: cldgdfaa 'prompt'"; return 1; }
    { echo "$1"; echo ""; echo "Here are all the changes:"; echo ""; gunaa; } | claude
}

cldgdf() {
    [ -z "$1" ] && { echo "Usage: cldgdf 'prompt'"; return 1; }
    { echo "$1"; echo ""; echo "Here are the git changes:"; echo ""; git --no-pager diff -p; } | claude
}

# ============================================================
# System aliases
# ============================================================
alias reswap='sudo swapoff -a && sudo swapon -a'
alias monoff='sleep 1; xset dpms force off'
alias usage='du -sh .[!.]* * | sort -h'
alias usag='du -sh * * | sort -h'
alias usager='du -sh * * | sort -h'
alias webserver='python -m SimpleHTTPServer 9090'
alias mailserver='sudo python -m smtpd -n -c DebuggingServer localhost:25'
alias install='sudo apt-get install'
alias ains='sudo apt install'
alias ainst='sudo apt install'
alias goo='go mod tidy && go run .'

# Lynx with cookies
alias lynx='lynx -accept_all_cookies -cookie_file=~/.lynx/cookies -cookie_save_file=~/.lynx/cookies'

# tmux
alias tx='tmux attach'
alias tls='tmux ls'
alias tn='tmux new -s'

# ============================================================
# Platform-specific clipboard/open
# ============================================================
if [[ ! "$(uname -s)" = "Darwin" ]]; then
    alias pbcopy='xclip -selection clipboard'
    alias pbpaste='xclip -selection clipboard -o'
    alias open='xdg-open'
    alias say='echo "$1" | espeak -s 120'
fi

# ============================================================
# Extract function
# ============================================================
extract() {
    if [ -f "$1" ]; then
        case "$1" in
            *.tar.bz2) tar xvjf "$1" ;;
            *.tar.gz)  tar xvzf "$1" ;;
            *.tar.xz)  tar xvJf "$1" ;;
            *.bz2)     bunzip2 "$1" ;;
            *.rar)     unrar x "$1" 2>/dev/null || rar x "$1" ;;
            *.gz)      gunzip "$1" ;;
            *.tar)     tar xvf "$1" ;;
            *.tbz2)    tar xvjf "$1" ;;
            *.tgz)     tar xvzf "$1" ;;
            *.zip)     unzip "$1" ;;
            *.Z)       uncompress "$1" ;;
            *.7z)      7z x "$1" ;;
            *)         echo "don't know how to extract '$1'..." ;;
        esac
    else
        echo "'$1' is not a valid file!"
    fi
}

mktar() { tar cvf  "${1%%/}.tar"     "${1%%/}/"; }
mktgz() { tar cvzf "${1%%/}.tar.gz"  "${1%%/}/"; }
mktbz() { tar cvjf "${1%%/}.tar.bz2" "${1%%/}/"; }
mkgz()  { gzip -v -c "$1" > "$1.gz"; }
# Note: compress() function defined in cross_platform_utils
# alias compress='mktgz'  # Use mktgz directly

# ============================================================
# Network helpers
# ============================================================
my_ip() {
    local MY_IP=$(ip route get 8.8.8.8 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' | head -1)
    echo ${MY_IP:-"Not connected"}
}
public_ip() { curl -s ifconfig.me || curl -s icanhazip.com; }
portkill() {
    [ -z "$1" ] && { echo "Usage: portkill <port>"; return 1; }
    lsof -ti:"$1" | xargs kill -9 2>/dev/null || echo "No process found"
}

# ============================================================
# FZF configuration
# ============================================================
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --preview 'bat --style=numbers --color=always --line-range :500 {}'"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND="fd --type d --hidden --follow --exclude .git"

# FZF functions
fe() {
    local files
    IFS=$'\n' files=($(fzf-tmux --query="$1" --multi --select-1 --exit-0))
    [[ -n "$files" ]] && ${EDITOR:-vim} "${files[@]}"
}

fo() {
    local out file key
    IFS=$'\n' out=("$(fzf-tmux --query="$1" --exit-0 --expect=ctrl-o,ctrl-e)")
    key=$(head -1 <<< "$out")
    file=$(head -2 <<< "$out" | tail -1)
    if [ -n "$file" ]; then
        [ "$key" = ctrl-o ] && open "$file" || ${EDITOR:-vim} "$file"
    fi
}

fd() {
    local DIR=$(find * -maxdepth 0 -type d -print 2>/dev/null | fzf-tmux)
    [ -n "$DIR" ] && cd "$DIR"
}

fda() {
    local dir=$(find ${1:-.} -type d 2>/dev/null | fzf +m)
    [ -n "$dir" ] && cd "$dir"
}

fh() {
    local cmd
    cmd=$( ([ -n "$ZSH_NAME" ] && fc -l 1 || history) | fzf +s --tac --no-sort --query "$*" | sed 's/ *[0-9]* *//' | sed 's/\[[^]]*\] //')
    if [ -n "$cmd" ]; then
        echo "$cmd"
        command -v xclip &>/dev/null && echo -n "$cmd" | xclip -selection clipboard && echo "(Copied to clipboard)"
    fi
}

# ============================================================
# Hg aliases (legacy)
# ============================================================
alias hcl='hg clone'
alias hst='hg summary;hg st'
alias hdf='hg diff'
alias hup='hg update'
alias hbr='hg branch'
alias hbrs='hg branches'
alias hpsh='hg push'
alias hpl='hg pull'
alias hlg='hg log'
alias hlgg='hg log --graph'
alias hcm='hg commit -m'

# ============================================================
# Shell fixup
# ============================================================
fixup() {
    echo "Reloading shell configuration..."
    if [ -n "$ZSH_VERSION" ]; then
        source ~/.zshrc
        echo "✓ Zsh configuration reloaded"
    elif [ -n "$BASH_VERSION" ]; then
        source ~/.bashrc
        echo "✓ Bash configuration reloaded"
    fi
}

# Search aliases and functions
algrp() {
    local pattern="$1"
    [ -z "$pattern" ] && { echo "Usage: algrp <pattern>"; return 1; }
    echo "=== Aliases ==="
    alias | grep -i "$pattern"
    echo -e "\n=== Functions ==="
    declare -F | awk '{print $3}' | grep -i "$pattern"
}

# ============================================================
# Source secrets and lib files
# ============================================================
[ -f ~/.secretbashrc ] && . ~/.secretbashrc

# Source cross-platform utilities
[ -f ~/code/dotfiles/lib/cross_platform_utils ] && . ~/code/dotfiles/lib/cross_platform_utils

# Source trace toolkit
[ -f ~/code/dotfiles/tools/trace-toolkit.sh ] && . ~/code/dotfiles/tools/trace-toolkit.sh

# Source watcher utils
[ -f ~/code/dotfiles/tools/watcher-utils.sh ] && . ~/code/dotfiles/tools/watcher-utils.sh >/dev/null 2>&1

# Source local environment
[ -f "$HOME/.local/bin/env" ] && . "$HOME/.local/bin/env"

# Hub setup
command -v hub >/dev/null 2>&1 && eval "$(hub alias -s)" 2>/dev/null

# ============================================================
# NVM (lazy loaded)
# ============================================================
export NVM_DIR="$HOME/.nvm"
if [ -n "$ZSH_VERSION" ]; then
    # In zsh, load nvm directly (lazy loading breaks zsh completion)
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" --no-use 2>/dev/null
else
    # In bash, use lazy loading for speed
    _lazy_load_nvm() {
        unset -f nvm node npm npx 2>/dev/null
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
    }
    nvm()  { _lazy_load_nvm; nvm "$@"; }
    node() { _lazy_load_nvm; node "$@"; }
    npm()  { _lazy_load_nvm; npm "$@"; }
    npx()  { _lazy_load_nvm; npx "$@"; }
fi

# ============================================================
# Pyenv
# ============================================================
export PYENV_ROOT="$HOME/.pyenv"
[ -d "$PYENV_ROOT/bin" ] && export PATH="$PYENV_ROOT/bin:$PATH"
if [ -d "$PYENV_ROOT" ] && command -v pyenv >/dev/null 2>&1; then
    eval "$(pyenv init --path)"
fi

# ============================================================
# Conda (single init)
# ============================================================
if [ -f "$HOME/miniconda3/bin/conda" ]; then
    __conda_setup="$("$HOME/miniconda3/bin/conda" "shell.$(basename $SHELL)" 'hook' 2>/dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    elif [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
        . "$HOME/miniconda3/etc/profile.d/conda.sh"
    else
        export PATH="$HOME/miniconda3/bin:$PATH"
    fi
    unset __conda_setup
fi

# ============================================================
# SDKMAN (lazy loaded)
# ============================================================
export SDKMAN_DIR="$HOME/.sdkman"
if [ -n "$ZSH_VERSION" ]; then
    [[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"
else
    _lazy_load_sdkman() {
        unset -f sdk java gradle maven 2>/dev/null
        [[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"
    }
    sdk() { _lazy_load_sdkman; sdk "$@"; }
fi

# ============================================================
# Cargo/Rust (lazy loaded)
# ============================================================
if [ -z "$ZSH_VERSION" ]; then
    cargo() { [ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"; unset -f cargo rustc rustup 2>/dev/null; cargo "$@"; }
    rustc() { [ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"; unset -f cargo rustc rustup 2>/dev/null; rustc "$@"; }
else
    [ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"
fi

# ============================================================
# GVM (Go Version Manager)
# ============================================================
[[ -s "$HOME/.gvm/scripts/gvm" ]] && source "$HOME/.gvm/scripts/gvm"

# ============================================================
# Google Cloud SDK
# ============================================================
if [ -n "$ZSH_VERSION" ]; then
    [ -f "$HOME/programs/google-cloud-sdk/path.zsh.inc" ] && . "$HOME/programs/google-cloud-sdk/path.zsh.inc"
    [ -f "$HOME/programs/google-cloud-sdk/completion.zsh.inc" ] && . "$HOME/programs/google-cloud-sdk/completion.zsh.inc"
else
    [ -f "$HOME/programs/google-cloud-sdk/path.bash.inc" ] && . "$HOME/programs/google-cloud-sdk/path.bash.inc"
    [ -f "$HOME/programs/google-cloud-sdk/completion.bash.inc" ] && . "$HOME/programs/google-cloud-sdk/completion.bash.inc"
fi

# ============================================================
# Bun completions
# ============================================================
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# Nix
[ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ] && . "$HOME/.nix-profile/etc/profile.d/nix.sh"

# SSH agent persistence
SSH_ENV="$HOME/.ssh/agent-environment"
_start_ssh_agent() {
    ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" > /dev/null
}
if [ -f "${SSH_ENV}" ]; then
    . "${SSH_ENV}" > /dev/null
    ps -p ${SSH_AGENT_PID} > /dev/null 2>&1 || _start_ssh_agent
else
    _start_ssh_agent
fi
